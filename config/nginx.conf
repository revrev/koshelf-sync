pid tmp/{{GIN_ENV}}-nginx.pid;

# run gin in foreground
# daemon off;

# This number should be at maxium the number of CPU on the server
worker_processes 4;

events {
    # Number of connections per worker
    worker_connections 4096;
}

http {
    include       /opt/openresty/nginx/conf/mime.types;
    default_type  application/octet-stream;

    # use sendfile
    sendfile on;

    log_format koshelf '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" "$http_user_agent" '
                      'req_id=$request_id user=$http_x_auth_user upstream=$upstream_addr';

    # Gin initialization
    {{GIN_INIT}}

    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # for http traffic
    server {
        listen 1{{GIN_PORT}};

        keepalive_timeout 70;

        # Gin runtime
        {{GIN_RUNTIME}}

        location = /audiobookshelf {
            default_type text/html;
            content_by_lua_block {
                local file = io.open("/app/koshelf-sync/public/audiobookshelf/index.html", "rb")
                if not file then
                    ngx.status = ngx.HTTP_NOT_FOUND
                    ngx.say("Audiobookshelf UI not available")
                    return
                end
                ngx.header["Cache-Control"] = "no-store"
                ngx.print(file:read("*a"))
                file:close()
            }
        }

        location /audiobookshelf/ {
            root /app/koshelf-sync/public;
            try_files $uri $uri/ /audiobookshelf/index.html;
        }

        location = /react {
            return 302 /react/;
        }

        location /react/ {
            root /app/koshelf-sync/public;
            try_files $uri $uri/ /react/index.html;
        }

        # Access and error logs capture UI + API activity
        access_log logs/{{GIN_ENV}}-access.log koshelf;
        error_log logs/{{GIN_ENV}}-error.log info;
    }

    # for https traffic
    server {
        # List port
        listen {{GIN_PORT}} ssl;

        keepalive_timeout 70;

        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_certificate /etc/nginx/ssl/nginx.crt;
        ssl_certificate_key /etc/nginx/ssl/nginx.key;
        ssl_ciphers HIGH:!aNULL:!MD5;

        access_log logs/{{GIN_ENV}}-access.log koshelf;
        error_log logs/{{GIN_ENV}}-error.log info;

        # Gin runtime
        {{GIN_RUNTIME}}

        location = /audiobookshelf {
            default_type text/html;
            content_by_lua_block {
                local file = io.open("/app/koshelf-sync/public/audiobookshelf/index.html", "rb")
                if not file then
                    ngx.status = ngx.HTTP_NOT_FOUND
                    ngx.say("Audiobookshelf UI not available")
                    return
                end
                ngx.header["Cache-Control"] = "no-store"
                ngx.print(file:read("*a"))
                file:close()
            }
        }

        location /audiobookshelf/ {
            root /app/koshelf-sync/public;
            try_files $uri $uri/ /audiobookshelf/index.html;
        }

        location = /react {
            return 302 /react/;
        }

        location /react/ {
            root /app/koshelf-sync/public;
            try_files $uri $uri/ /react/index.html;
        }
    }
}
